<!-- profile.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Profile | Linux CTF</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0c0f0d; --panel:#0b1310; --border:#0f221a;
      --ink:#03f484; --ink-d:#03f484b3; --ink-f:#03f48455;
      --danger:#ff4d4d;
      --radius:14px; --cell:12px; --gap:3px; --month-gap:10px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;display:flex;min-height:100vh;
      background: radial-gradient(1200px 600px at 20% -10%, #0e1a14 2%, #0c0f0d 55%) fixed;
      color:var(--ink);font-family:"Share Tech Mono", monospace;
    }

    /* Sidebar */
    .sidebar{
      width:220px;min-width:220px;height:100vh;position:sticky;top:0;
      background:#111;padding:22px 18px 90px;box-shadow:3px 0 18px #03f48440;
    }
    .sidebar h2{margin:0 0 20px;font-size:22px}
    .sidebar a{display:block;color:var(--ink);text-decoration:none;margin:10px 0}
    .sidebar a:hover{ text-shadow:0 0 10px var(--ink) }
    .logout{position:absolute;left:18px;right:18px;bottom:18px}
    .btn{width:100%;padding:8px 12px;border:1px solid var(--danger);color:var(--danger);background:transparent;border-radius:10px;cursor:pointer}
    .btn:hover{background:rgba(255,77,77,.1)}

    /* Content */
    .content{flex:1;max-width:1100px;padding:36px 42px}

    .profile-header{display:flex;align-items:center;gap:24px;margin-bottom:22px}
    .profile-photo-wrapper{position:relative;width:120px;height:120px}
    .profile-photo-wrapper img,.initials{
      width:120px;height:120px;border-radius:50%;border:2px solid var(--ink);
      object-fit:cover;background:#0f0f0f;color:var(--ink);display:block;text-align:center;line-height:120px;font-size:36px;
    }
    .upload-form{position:absolute;right:-8px;bottom:-8px}
    .upload-form label{cursor:pointer;background:var(--ink);color:#000;border-radius:999px;font-size:12px;padding:6px 10px}
    .upload-form input[type=file]{display:none}

    .profile-meta p{margin:4px 0;color:var(--ink-d)}

    /* Streak Panel */
    .streak-wrap{
      margin-top:12px;background:var(--panel);border:1px solid var(--border);
      border-radius:var(--radius);padding:16px;box-shadow:0 0 12px var(--ink-f)
    }
    .streak-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .streak-title{display:flex;align-items:center;gap:10px}
    .streak-title h3{margin:0;font-size:16px}
    .pill{font-size:12px;border:1px solid var(--ink);color:var(--ink);padding:2px 8px;border-radius:999px}
    .year-select{
      display:flex;align-items:center;gap:8px
    }
    .year-select label{color:var(--ink-d)}
    .year-select select{
      background:#020403;color:var(--ink);border:1px solid var(--ink);border-radius:8px;
      padding:6px 10px;font-family:inherit
    }

    /* GitHub-like calendar */
    .streak-months, .streak-grid{
      display:grid;grid-auto-flow:column;grid-auto-columns:var(--cell);gap:var(--gap)
    }
    .streak-months{
      grid-template-rows:16px;color:#b9f7db;font-size:11px;margin-left:2px;user-select:none
    }
    .streak-grid{grid-template-rows:repeat(7,var(--cell))}
    .streak-cell{
      width:var(--cell);height:var(--cell);border:1px solid var(--border);border-radius:2px;background:#0a1612
    }
    .streak-cell.active{background:var(--ink);box-shadow:0 0 6px var(--ink-f)}
    .month-spacer{width:var(--month-gap)}
    .week-spacer{width:var(--month-gap);grid-row:1 / span 7}
    .month-label{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Linux CTF</h2>
    <a href="/dashboard">Modules</a>
    <a href="/profile">Profile</a>
    <a href="/settings">Settings</a>
    <form class="logout" action="/logout" method="POST">
      <button class="btn" type="submit">Logout</button>
    </form>
  </aside>

  <main class="content">
    <header class="profile-header">
      <div class="profile-photo-wrapper">
        <img src="/profile-photo/{{ user.uid }}" alt="Profile Photo"
             onerror="this.style.display='none'; document.getElementById('initials').style.display='block';" />
        <div id="initials" class="initials" style="display:none;">{{ (user.username or '')[:1]|upper }}</div>
        <form class="upload-form" action="/upload-photo" method="POST" enctype="multipart/form-data">
          <label for="photo">Change</label>
          <input id="photo" type="file" name="photo" accept="image/*" onchange="this.form.submit();" />
        </form>
      </div>

      <div class="profile-meta">
        <h2 style="margin:0 0 4px 0;">{{ user.username }}</h2>
        <p>Email: {{ user.email }}</p>
        <p>Levels Completed: {{ user.last_completed_level or 0 }}</p>
        <p>Streak: {{ user.streak_count or 0 }} day(s)</p>
      </div>
    </header>

    <section class="streak-wrap">
      <div class="streak-head">
        <div class="streak-title">
          <h3>Activity in</h3>
          <span class="pill">{{ selected_year }}</span>
        </div>
        <div class="year-select">
          <label for="year">Year</label>
          <select id="year" onchange="location.href='/profile?year=' + this.value;">
            {% for y in year_options %}
              <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- months row (labels) -->
      <div id="streak-months" class="streak-months" aria-hidden="true"></div>
      <!-- calendar grid -->
      <div id="streak-grid" class="streak-grid" aria-label="Daily streak activity"></div>
    </section>
  </main>

  <script>
    (function () {
      const MARKED = new Set({{ streak_dates | tojson | safe }}); // list of "YYYY-MM-DD"
      const year = {{ selected_year }};
      const monthsRow = document.getElementById('streak-months');
      const grid = document.getElementById('streak-grid');

      // Build calendar bounds: first Sunday on/before Jan 1, last Saturday on/after Dec 31 (UTC)
      const jan1 = new Date(Date.UTC(year, 0, 1));
      const dec31 = new Date(Date.UTC(year, 11, 31));
      const daysBackToSun = (jan1.getUTCDay() + 7 - 0) % 7; // Sun=0
      const daysFwdToSat  = (6 + 7 - dec31.getUTCDay() + (6-1)) % 7; // simpler way below instead
      // Better: Sunday=0 .. Saturday=6
      const start = new Date(jan1); start.setUTCDate(jan1.getUTCDate() - jan1.getUTCDay());
      const end   = new Date(dec31); end.setUTCDate(dec31.getUTCDate() + ((6 - dec31.getUTCDay()) % 7));

      let d = new Date(start);
      let currentLabeledMonth = -1;

      function addMonthLabel(name) {
        const label = document.createElement('div');
        label.className = 'month-label';
        label.textContent = name;
        monthsRow.appendChild(label);
      }
      function addMonthGap() {
        const mt = document.createElement('div'); mt.className = 'month-spacer'; monthsRow.appendChild(mt);
        const wg = document.createElement('div'); wg.className = 'week-spacer';  grid.appendChild(wg);
      }

      while (d <= end) {
        const firstWeekOfMonth = (d.getUTCDate() <= 7);
        if (firstWeekOfMonth) {
          const changed = d.getUTCMonth() !== currentLabeledMonth;
          if (changed) {
            if (currentLabeledMonth !== -1) addMonthGap();
            currentLabeledMonth = d.getUTCMonth();
            addMonthLabel(d.toLocaleString('en', { month: 'short', timeZone: 'UTC' }));
          } else {
            monthsRow.appendChild(document.createElement('div'));
          }
        } else {
          monthsRow.appendChild(document.createElement('div'));
        }

        for (let r = 0; r < 7; r++) {
          const cell = document.createElement('div');
          cell.className = 'streak-cell';
          const iso = d.toISOString().slice(0,10); // YYYY-MM-DD
          if (MARKED.has(iso)) cell.classList.add('active');
          grid.appendChild(cell);
          d.setUTCDate(d.getUTCDate() + 1);
        }
      }
    })();
  </script>
</body>
</html>